# detectors/kernel_exploits.py
import platform
import subprocess

class KernelExploitDetector:
    def __init__(self):
        self.name = "Kernel Exploit Detector"
        self.findings = []
    
    def scan(self):
        """Scan for kernel-level vulnerabilities"""
        self.check_os_version()
        self.check_hotfixes()
        self.check_kernel_configurations()
        return self.findings
    
    def check_os_version(self):
        """Check OS version for known vulnerabilities"""
        try:
            os_info = platform.platform()
            version_info = platform.version()
            build_info = platform.win32_ver()
            
            # Known vulnerable versions (simplified check)
            vulnerable_versions = [
                "10.0.14393",  # Windows 10 1607
                "10.0.15063",  # Windows 10 1703
                "10.0.16299",  # Windows 10 1709
                "10.0.17134",  # Windows 10 1803
                "10.0.17763",  # Windows 10 1809
                "10.0.18362",  # Windows 10 1903
                "10.0.18363",  # Windows 10 1909
            ]
            
            current_version = version_info
            is_vulnerable = any(vuln_ver in current_version for vuln_ver in vulnerable_versions)
            
            if is_vulnerable:
                self.add_finding(
                    title=f"Potential Kernel Vulnerability: {current_version}",
                    description=f"Operating system version {current_version} may have known kernel vulnerabilities",
                    risk="critical",
                    evidence=f"OS Version: {os_info}, Build: {build_info}",
                    mitigation="Apply all available Windows updates and security patches"
                )
            else:
                self.add_finding(
                    title=f"OS Version Check: {current_version}",
                    description=f"Current OS version: {current_version}",
                    risk="low",
                    evidence=f"OS Info: {os_info}",
                    mitigation="Keep system updated with latest security patches"
                )
                
        except Exception as e:
            self.add_finding(
                title="OS Version Check Failed",
                description=f"Unable to check OS version: {str(e)}",
                risk="low",
                evidence=str(e),
                mitigation="Manual OS version verification required"
            )
    
    def check_hotfixes(self):
        """Check installed hotfixes and updates"""
        try:
            result = subprocess.run([
                'wmic', 'qfe', 'list', 'brief'
            ], capture_output=True, text=True)
            
            # Count installed updates
            update_count = len([line for line in result.stdout.split('\n') if 'KB' in line])
            
            if update_count < 50:  # Arbitrary threshold
                self.add_finding(
                    title="Low Number of Security Updates",
                    description=f"Only {update_count} security updates installed, system may be vulnerable",
                    risk="high",
                    evidence=f"Installed updates: {update_count}",
                    mitigation="Install all available Windows updates immediately"
                )
            else:
                self.add_finding(
                    title="Adequate Security Updates",
                    description=f"System has {update_count} security updates installed",
                    risk="low",
                    evidence=f"Update count: {update_count}",
                    mitigation="Continue regular update maintenance"
                )
                
        except Exception as e:
            self.add_finding(
                title="Update Check Failed",
                description=f"Unable to check installed updates: {str(e)}",
                risk="medium",
                evidence=str(e),
                mitigation="Manual update verification required"
            )
    
    def check_kernel_configurations(self):
        """Check kernel security configurations"""
        try:
            # Check for driver signature enforcement
            result = subprocess.run([
                'reg', 'query', 'HKLM\\SYSTEM\\CurrentControlSet\\Control\\CI\\Policy', '/v', 'UpgradedSystem'
            ], capture_output=True, text=True)
            
            # Check various kernel security settings
            checks = [
                {
                    'key': 'HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Memory Management\\FeatureSettings',
                    'value': 'FeatureSettingsOverride',
                    'description': 'Kernel ASLR settings'
                },
                {
                    'key': 'HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\kernel',
                    'value': 'DisableExceptionChainValidation',
                    'description': 'Exception chain validation'
                }
            ]
            
            for check in checks:
                try:
                    subprocess.run([
                        'reg', 'query', check['key'], '/v', check['value']
                    ], capture_output=True, text=True)
                    # If we can query these, they might be configured
                except:
                    pass
            
            self.add_finding(
                title="Kernel Security Configuration",
                description="Review kernel security configurations for optimal protection",
                risk="medium",
                evidence="Manual kernel configuration review recommended",
                mitigation="Implement recommended kernel security settings from Microsoft security baseline"
            )
            
        except Exception as e:
            print(f"Kernel configuration check error: {e}")
    
    def add_finding(self, title, description, risk, evidence, mitigation):
        """Add a finding to the results"""
        self.findings.append({
            'title': title,
            'description': description,
            'risk_level': risk,
            'category': 'kernel',
            'evidence': evidence,
            'mitigation': mitigation,
            'cvss_score': self.calculate_cvss(risk)
        })
    
    def calculate_cvss(self, risk):
        """Calculate CVSS score based on risk level"""
        scores = {
            'critical': 9.0,
            'high': 7.5,
            'medium': 5.5,
            'low': 3.0
        }
        return scores.get(risk, 5.0)